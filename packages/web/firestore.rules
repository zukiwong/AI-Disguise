rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // ç”¨æˆ·æ–‡æ¡£ - åªæœ‰ç”¨æˆ·æœ¬äººå¯ä»¥è¯»å†™
    match /users/{userId} {
      // å…è®¸ç”¨æˆ·è¯»å–å’Œå†™å…¥è‡ªå·±çš„æ–‡æ¡£
      allow read: if request.auth != null && request.auth.uid == userId;

      // å…è®¸ç”¨æˆ·åˆ›å»ºè‡ªå·±çš„æ–‡æ¡£ï¼ˆæ³¨å†Œæ—¶ï¼‰
      allow create: if request.auth != null && request.auth.uid == userId;

      // å…è®¸ç”¨æˆ·æ›´æ–°è‡ªå·±çš„æ–‡æ¡£ï¼Œä½†ä¸èƒ½ä¿®æ”¹ uid
      allow update: if request.auth != null &&
                       request.auth.uid == userId &&
                       request.resource.data.uid == resource.data.uid;

      // ä¸å…è®¸åˆ é™¤ç”¨æˆ·æ–‡æ¡£ï¼ˆå®‰å…¨è€ƒè™‘ï¼‰
      allow delete: if false;
    }

    // é£æ ¼æ–‡æ¡£
    match /styles/{styleId} {
      // æ‰€æœ‰äººå¯ä»¥è¯»å–å…¬å…±é£æ ¼
      allow read: if resource.data.isPublic == true;

      // æ‰€æœ‰äººå¯ä»¥è¯»å–ç³»ç»Ÿé£æ ¼
      allow read: if resource.data.createdBy == 'system';

      // ç™»å½•ç”¨æˆ·å¯ä»¥è¯»å–è‡ªå·±çš„ç§æœ‰é£æ ¼
      allow read: if request.auth != null &&
                     request.auth.uid == resource.data.createdBy;

      // ğŸ”¥ å…è®¸åˆ›å»ºç³»ç»Ÿé£æ ¼ï¼ˆç”¨äºæ•°æ®åˆå§‹åŒ–ï¼‰
      allow create: if request.resource.data.createdBy == 'system';

      // ç™»å½•ç”¨æˆ·å¯ä»¥åˆ›å»ºé£æ ¼
      allow create: if request.auth != null &&
                       request.auth.uid == request.resource.data.createdBy;

      // ç”¨æˆ·åªèƒ½æ›´æ–°è‡ªå·±åˆ›å»ºçš„é£æ ¼
      allow update: if request.auth != null &&
                       request.auth.uid == resource.data.createdBy;

      // ç”¨æˆ·åªèƒ½åˆ é™¤è‡ªå·±åˆ›å»ºçš„ç§æœ‰é£æ ¼
      allow delete: if request.auth != null &&
                       request.auth.uid == resource.data.createdBy &&
                       resource.data.isPublic == false;

      // å˜ä½“å­é›†åˆçš„è§„åˆ™
      match /variants/{variantId} {
        // å…è®¸è¯»å–æ‰€æœ‰å…¬å¼€çš„å˜ä½“
        allow read: if resource.data.isPublic == true;

        // å…è®¸ç™»å½•ç”¨æˆ·è¯»å–è‡ªå·±åˆ›å»ºçš„å˜ä½“
        allow read: if request.auth != null &&
                       request.auth.uid == resource.data.createdBy;

        // ğŸ”¥ å…è®¸åˆ›å»ºç³»ç»Ÿå˜ä½“ï¼ˆç”¨äºæ•°æ®åˆå§‹åŒ–ï¼‰
        allow create: if request.resource.data.createdBy == 'system';

        // å…è®¸ç™»å½•ç”¨æˆ·åˆ›å»ºæ–°çš„å˜ä½“ï¼ˆä½†ä¼šè®°å½•åˆ›å»ºè€…ï¼‰
        allow create: if request.auth != null &&
                        request.auth.uid == request.resource.data.createdBy;

        // å…è®¸åˆ›å»ºè€…ä¿®æ”¹å’Œåˆ é™¤è‡ªå·±çš„å˜ä½“
        allow update, delete: if request.auth != null &&
                                request.auth.uid == resource.data.createdBy;
      }
    }

    // åˆ†äº«å†…å®¹æ–‡æ¡£
    match /posts/{postId} {
      // å…è®¸æ‰€æœ‰äººè¯»å–ï¼ˆåœ¨åº”ç”¨å±‚é¢æ§åˆ¶ isPublicï¼‰
      allow read: if true;

      // åªæœ‰ç™»å½•ç”¨æˆ·å¯ä»¥åˆ›å»ºï¼Œä¸”å¿…é¡»è®¾ç½®æ­£ç¡®çš„ authorId
      allow create: if request.auth != null &&
                       request.auth.uid == request.resource.data.authorId;

      // åªæœ‰ä½œè€…å¯ä»¥æ›´æ–°å’Œåˆ é™¤è‡ªå·±çš„å†…å®¹
      allow update, delete: if request.auth != null &&
                               request.auth.uid == resource.data.authorId;
    }
  }
}
